{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniCompanion - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="{% static 'styles/design.css' %}">
    <link rel="stylesheet" href="{% static 'styles/reportCon.css' %}">
</head>

<body>
    {% include 'includes/adminNav.html' %}

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="flex flex-col md:flex-row gap-6">
            {% include 'includes/adminSideBar.html' %}

            <!-- Main Content -->
            <div class="main-content">
                <!-- Top Bar -->
                <header class="content-header bg-white text-black dark:text-black">
                    <button class="sidebar-toggle hidden">
                        <i class="toggle-icon fas fa-bars"></i>
                    </button>

                    <div class="header-title-container ">
                        <h1 class="header-title bg-white text-black dark:text-black">Reported Content</h1>
                    </div>
                </header>

                <!-- Filter Menu -->
                <div class="filter-menu bg-white text-black dark:text-black">
                    <button class="filter-item active bg-white text-black dark:text-black" data-type="all">
                        <i class="fas fa-list"></i> All Reports
                    </button>
                    <button class="filter-item bg-white text-black dark:text-black" data-type="posts">
                        <i class="fas fa-file-alt"></i> Posts
                    </button>
                    <button class="filter-item bg-white text-black dark:text-black" data-type="comments">
                        <i class="fas fa-comment"></i> Comments
                    </button>
                    <button class="filter-item bg-white text-black dark:text-black" data-type="users">
                        <i class="fas fa-user"></i> Users
                    </button>
                </div>

                <!-- Content Card -->
                <div class="content-card bg-white text-black dark:text-black">
                    <div class="card-header ">
                        <h2 class="card-title">Reports</h2>
<!--                        <div class="batch-actions">-->
<!--                            <div class="batch-select">-->
<!--                                <input type="checkbox" id="select-all">-->
<!--                                <label for="select-all">Select All</label>-->
<!--                            </div>-->
<!--                            <button class="btn btn-danger btn-sm" id="bulk-delete">-->
<!--                                <i class="fas fa-trash"></i> Delete Selected-->
<!--                            </button>-->
<!--                            <button class="btn btn-secondary btn-sm" id="bulk-dismiss">-->
<!--                                <i class="fas fa-check"></i> Dismiss Selected-->
<!--                            </button>-->
<!--                        </div>-->
                    </div>

                    <div class="table-container ">
                        <table class="report-table">
                            <thead>
                                <tr>
                                    <th class="bg-white text-black dark:text-black">Post ID</th>
                                    <th class="bg-white text-black dark:text-black">Timestamp</th>
                                    <th class="bg-white text-black dark:text-black">Reasons</th>
                                    <th class="bg-white text-black dark:text-black">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table-body">
                                <!-- Table rows will be populated by JavaScript -->

                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Context Modal -->
                <div id="context-modal" class="context-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Content Context</h3>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div class="context-content" id="context-content">
                            <!-- Context content will be populated by JavaScript -->
                        </div>
                        <div class="modal-actions">
                            <button class="btn btn-danger">Delete Content</button>
                            <button class="btn btn-secondary">Dismiss Report</button>
                            <button class="btn btn-primary">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const data = {
            posts: [
                {% for post_report in post_reports %}
                {
                    id: 'P{{ post_report.post_id }}',
                    timestamp: '{{ post_report.created_at|date:"d M Y, P" }}',
                    reasons: ['{{ post_report.content }}'],
                    fullReasons: ['{{ post_report.content }}'],
                },
                {% endfor %}
                // {
                //     id: 'P002',
                //     timestamp: '2024-01-15 10:15:45',
                //     reportCount: 3,
                //     reasons: ['Misinformation', 'Hate speech'],
                //     fullReasons: ['Spreading false information about vaccines', 'Contains hate speech targeting specific groups'],
                //     content: 'Another sample post with controversial content...',
                //     author: 'user999',
                //     comments: []
                // },
            ],
            comments: [
                {% for comment_report in comment_reports %}
                {
                    id: 'C{{ comment_report.comment_id }}',
                    timestamp: '{{ comment_report.created_at|date:"d M Y, P" }}',
                    reasons: ['{{ comment_report.content }}'],
                    fullReasons: ['{{ comment_report.content }}'],
                    parentPost: '{{ comment_report.comment.post.post_id }}'
                },
                {% endfor %}
            ],
            users: [
                {% for user_report in user_reports %}
                {
                    id: 'U{{ user_report.target_id }}',
                    timestamp: '{{ user_report.created_at|date:"d M Y, P" }}',
                    reasons: ['{{ user_report.content }}'],
                    fullReasons: ['{{ user_report.content }}'],
                    email: '{{ user_report.target.stu_email }}'
                },
                {% endfor %}
            ]
        };

        let currentFilter = 'all';
        let currentData = [];

        // Initialize the dashboard
        function init() {
            updateData();
            setupEventListeners();
        }

        // Update data based on current filter
        function updateData() {
            switch (currentFilter) {
                case 'posts':
                    currentData = data.posts;
                    break;
                case 'comments':
                    currentData = data.comments;
                    break;
                case 'users':
                    currentData = data.users;
                    break;
                default:
                    currentData = [...data.posts, ...data.comments, ...data.users];
            }
            renderTable();
        }

        // Render the table
        function renderTable() {
        const tableBody = document.getElementById('reports-table-body');
        tableBody.innerHTML = '';

        currentData.forEach(item => {
            let url = '';
            let del = 'Delete Post';
            let delAlignClass = 'text-center';

            if (item.id.startsWith('P')) {
                let postId = item.id.slice(1);
                url = `{% url 'indivPost' %}?postId=${postId}`;
            } else if (item.id.startsWith('C')) {
                del = 'Delete Text';
                let postId = item.parentPost;
                let commentId = item.id.slice(1);
                url = `{% url 'indivPost' %}?postId=${postId}&commentId=${commentId}`;
            } else if (item.id.startsWith('U')) {
                del = 'Ban User';
                delAlignClass = 'text-left';
                let email = item.email;
                url = `{% url 'profile' %}?email=${email}`;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
                <td><a href=${url} class="report-id">${item.id}</a></td>
                <td><span class="timestamp">${item.timestamp}</span></td>
                <td>
                    <div class="reasons-container">
                        <span class="reasons-short">${item.reasons[0].slice(0, 35)}${item.reasons[0].length > 35 ? '...' : ''}</span>
                        <span class="reasons-full" style="display: none;">${item.fullReasons.join(' ')}</span>
                        ${item.reasons[0].length > 35 ? '<span class="reasons-toggle" onclick="toggleReasons(this)">Show more</span>' : ''}
                    </div>
                </td>
                <td>
                    <div class="action-buttons flex gap-2">
                        <button class="btn btn-danger btn-sm w-32 ${delAlignClass} justify-start pl-3" onclick="deleteItem('${item.id}')">
                    <i class="fas fa-trash mr-1"></i> ${del}
                </button>

                        <button class="btn btn-secondary btn-sm w-32 text-center justify-center" onclick="dismissItem('${item.id}')">
                            <i class="fas fa-check"></i> Dismiss
                        </button>
                    </div>
                </td>
            `;
            tableBody.appendChild(row);
        });
    }


        // Setup event listeners
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-item').forEach(button => {
                button.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-item').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentFilter = button.dataset.type;
                    updateData();
                });
            });

            // Modal close
            document.querySelector('.close-btn').addEventListener('click', () => {
                document.getElementById('context-modal').style.display = 'none';
            });

            // // Select all checkbox
            // document.getElementById('select-all').addEventListener('change', (e) => {
            //     const checkboxes = document.querySelectorAll('.row-checkbox');
            //     checkboxes.forEach(checkbox => {
            //         checkbox.checked = e.target.checked;
            //     });
            // });

            // Bulk actions
            document.getElementById('bulk-delete').addEventListener('click', bulkDelete);
            document.getElementById('bulk-dismiss').addEventListener('click', bulkDismiss);
        }

        // Toggle reasons display
        function toggleReasons(element) {
            const container = element.parentElement;
            const shortReasons = container.querySelector('.reasons-short');
            const fullReasons = container.querySelector('.reasons-full');

            if (fullReasons.style.display === 'none') {
                shortReasons.style.display = 'none';
                fullReasons.style.display = 'block';
                element.textContent = 'Show less';
            } else {
                shortReasons.style.display = 'block';
                fullReasons.style.display = 'none';
                element.textContent = 'Show more';
            }
        }

        // // Show context modal  |  literally no usage
        // function showContext(id) {
        //     const item = currentData.find(item => item.id === id);
        //     if (!item) return;
        //
        //     const modal = document.getElementById('context-modal');
        //     const contextContent = document.getElementById('context-content');
        //
        //     let contextHtml = '';
        //
        //     if (item.content) {
        //         contextHtml = `
        //             <div class="original-post">
        //                 <h4>Original Content</h4>
        //                 <div class="comment-meta">
        //                     <span><strong>Author:</strong> ${item.author}</span>
        //                     <span><strong>Posted:</strong> ${item.timestamp}</span>
        //                 </div>
        //                 <div class="reported-content">${item.content}</div>
        //             </div>
        //         `;
        //
        //         if (item.comments && item.comments.length > 0) {
        //             contextHtml += `
        //                 <div class="comment-thread">
        //                     <h4>Comments</h4>
        //                     ${item.comments.map(comment => `
        //                         <div class="comment-item">
        //                             <div class="comment-meta">
        //                                 <span><strong>${comment.author}</strong></span>
        //                                 <span>${comment.timestamp}</span>
        //                             </div>
        //                             <div>${comment.content}</div>
        //                         </div>
        //                     `).join('')}
        //                 </div>
        //             `;
        //         }
        //     }
        //
        //     contextHtml += `
        //         <div class="report-details">
        //             <h4>Report Details</h4>
        //             <div><strong>Total Reports:</strong> ${item.reportCount}</div>
        //             <div><strong>Reasons:</strong></div>
        //             ${item.fullReasons.map(reason => `<div class="report-item">${reason}</div>`).join('')}
        //         </div>
        //     `;
        //
        //     contextContent.innerHTML = contextHtml;
        //     modal.style.display = 'block';
        // }

        // Delete item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this content?')) {
                console.log('Deleting item:', id);
                // Remove from current data and re-render
                currentData = currentData.filter(item => item.id !== id);
                fetch("{% url 'admin_reported_delete' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: `id=${id}`
                })
                renderTable();
            }
        }

        // Dismiss item
        function dismissItem(id) {
            if (confirm('Are you sure you want to dismiss this report?')) {
                console.log('Dismissing item:', id);
                // Remove from current data and re-render
                currentData = currentData.filter(item => item.id !== id);
                fetch("{% url 'admin_reported_dismiss' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: `id=${id}`
                })
                renderTable();
            }
        }

        // // Bulk delete
        // function bulkDelete() {
        //     const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
        //         .map(checkbox => checkbox.dataset.id);
        //
        //     if (selectedIds.length === 0) {
        //         alert('Please select items to delete.');
        //         return;
        //     }
        //
        //     if (confirm(`Are you sure you want to delete ${selectedIds.length} items?`)) {
        //         console.log('Bulk deleting items:', selectedIds);
        //         currentData = currentData.filter(item => !selectedIds.includes(item.id));
        //         renderTable();
        //     }
        // }
        //
        // // Bulk dismiss
        // function bulkDismiss() {
        //     const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked'))
        //         .map(checkbox => checkbox.dataset.id);
        //
        //     if (selectedIds.length === 0) {
        //         alert('Please select items to dismiss.');
        //         return;
        //     }
        //
        //     if (confirm(`Are you sure you want to dismiss ${selectedIds.length} reports?`)) {
        //         console.log('Bulk dismissing items:', selectedIds);
        //         currentData = currentData.filter(item => !selectedIds.includes(item.id));
        //         renderTable();
        //     }
        // }
        // Initialize the dashboard when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="{% static 'js/admin-function.js' %}"></script>
</body>

</html>