{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UniCompanion | AI Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f5f3ff',
                            100: '#ede9fe',
                            200: '#ddd6fe',
                            300: '#c4b5fd',
                            400: '#a78bfa',
                            500: '#8b5cf6',
                            600: '#7c3aed',
                            700: '#6d28d9',
                            800: '#5b21b6',
                            900: '#4c1d95',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        .chat-container {
            height: calc(100vh - 180px);
        }

        .message-animation {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #4b5563;
            margin: 0 2px;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes bounce {

            0%,
            60%,
            100% {
                transform: translateY(0);
            }

            30% {
                transform: translateY(-5px);
            }
        }
    </style>
    <link rel="stylesheet" href="{% static 'styles/design.css' %}">
</head>

<body class="bg-gray-50">
    {% include 'includes/navBar.html' %}

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <!-- Chat Container -->
        <div class="bg-white rounded-xl shadow-sm overflow-hidden">
            <!-- Chat Messages -->
            <div class="chat-container overflow-y-auto p-4 space-y-4" id="chatMessages">
                <!-- AI Welcome Message -->
                <div class="flex flex-col space-y-3 message-animation">
                    <div class="flex space-x-3">
                        <div class="flex-shrink-0">
                            <div
                                class="h-8 w-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                                <i class="fas fa-robot"></i>
                            </div>
                        </div>
                        <div class="bg-primary-50 rounded-lg p-3 max-w-3xl">
                            <p class="text-sm mb-2">Hello! üëã I'm your UniCompanion AI assistant. How can I help
                                you today?</p>

                            <!-- Preset Questions -->
                            <div class="space-y-2 text-sm">
                                <p class="font-semibold text-primary-700 mt-3">Choose a category to get started:</p>

                                {% for category in faq_category %}
                                <div class="space-y-3 mt-4">
                                    <button onclick="askQuestion({{ category.pk }})"
                                        class="category-card w-full text-left p-4 rounded-lg shadow-sm">
                                        <div class="flex items-center space-x-3">
                                            <div
                                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-lg">
                                                {% cycle 'üéì' 'üè´' 'ü§ì' 'üí∞' %}</div>
                                            <div>
                                                <div class="font-semibold text-primary-700">{{ category.pk }}. {{ category.name }}</div>
<!--                                                <div class="text-xs text-gray-500">GPA requirements, course info,-->
<!--                                                    lecturer contacts</div>-->
                                            </div>
                                        </div>
                                    </button>


<!--                                    <button onclick="askQuestion(2)"-->
<!--                                        class="category-card w-full text-left p-4 rounded-lg shadow-sm">-->
<!--                                        <div class="flex items-center space-x-3">-->
<!--                                            <div-->
<!--                                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-lg">-->
<!--                                                üè´</div>-->
<!--                                            <div>-->
<!--                                                <div class="font-semibold text-primary-700">2. Life on Campus</div>-->
<!--                                                <div class="text-xs text-gray-500">Events, transportation, clubs,-->
<!--                                                    facilities</div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </button>-->

<!--                                    <button onclick="askQuestion(3)"-->
<!--                                        class="category-card w-full text-left p-4 rounded-lg shadow-sm">-->
<!--                                        <div class="flex items-center space-x-3">-->
<!--                                            <div-->
<!--                                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-lg">-->
<!--                                                üí∞</div>-->
<!--                                            <div>-->
<!--                                                <div class="font-semibold text-primary-700">3. Scholarships & Financial-->
<!--                                                    Aid-->
<!--                                                </div>-->
<!--                                                <div class="text-xs text-gray-500">Applications, deadlines, requirements-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </button>-->

<!--                                    <button onclick="askQuestion(4)"-->
<!--                                        class="category-card w-full text-left p-4 rounded-lg shadow-sm">-->
<!--                                        <div class="flex items-center space-x-3">-->
<!--                                            <div-->
<!--                                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-lg">-->
<!--                                                üìö</div>-->
<!--                                            <div>-->
<!--                                                <div class="font-semibold text-primary-700">4. Library & Academic-->
<!--                                                    Support-->
<!--                                                </div>-->
<!--                                                <div class="text-xs text-gray-500">-->
<!--                                                </div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </button>-->

<!--                                    <button onclick="askQuestion(5)"-->
<!--                                        class="category-card w-full text-left p-4 rounded-lg shadow-sm">-->
<!--                                        <div class="flex items-center space-x-3">-->
<!--                                            <div-->
<!--                                                class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center text-lg">-->
<!--                                                üéì</div>-->
<!--                                            <div>-->
<!--                                                <div class="font-semibold text-primary-700">1. Newcomers Common Questions</div>-->
<!--                                                <div class="text-xs text-gray-500"></div>-->
<!--                                            </div>-->
<!--                                        </div>-->
<!--                                    </button>-->
                                </div>
                                {% endfor %}

                                {% for category in faq_category %}
                                <div id="content{{ category.pk }}"
                                    class="content hidden mt-4 p-4 bg-white border border-primary-200 rounded-lg shadow-sm">
                                    <h3 class="font-semibold text-primary-700 mb-3 flex items-center">
                                        <span
                                            class="w-6 h-6 bg-primary-100 rounded-full flex items-center justify-center text-sm mr-2">üéì</span>
                                        {{ category.name }}
                                    </h3>
                                    <div class="space-y-1 text-sm">
                                        {% for faq in faqs %}
                                        {% if faq.category.pk == category.pk %}
                                        <button onclick="askQuestion('{{ faq.question }}')"
                                            class="question-button block w-full text-left p-3 rounded-lg">
                                            <div class="flex items-center space-x-2">
<!--                                                <span>üìà</span>-->
                                                <span>{{ faq.question }}</span>
                                            </div>
                                        </button>
                                        {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                                {% endfor %}
                                <p class="text-xs text-gray-500 mt-4">Other questions? Contact <a
                                        href="mailto:uniCompanionAssist@gmail.com"
                                        class="underline text-primary-600">unicompanion002@gmail.com</a></p>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- AI Response with Typing Indicator -->
                <div class="flex space-x-3" id="typingIndicator" style="display: none;">
                    <div class="flex-shrink-0">
                        <div
                            class="h-8 w-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                            <i class="fas fa-robot"></i>
                        </div>
                    </div>
                    <div class="bg-primary-50 rounded-lg p-3">
                        <div class="typing-indicator flex space-x-1">
                            <span></span>
                            <span></span>
                            <span></span>

                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-container border-t border-gray-200 p-4">
                <div class="flex items-center space-x-2">
                    <div class="flex-1 relative">
                        <input type="text" placeholder="Type your message or number (1-4)..."
                            class="w-full pl-4 pr-16 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 shadow-sm"
                            id="messageInput">
                        <div class="absolute right-3 top-1/2 transform -translate-y-1/2 flex space-x-1">
                            <button class="p-1 text-gray-400 hover:text-primary-600 transition-colors">
                                <i class="far fa-smile"></i>
                            </button>
                            <button id="sendButton"
                                class="p-2 text-primary-600 hover:text-primary-700 transition-colors">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="{% static 'js/function.js' %}"></script>
    <script>
        // Chat functionality
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const chatMessages = document.getElementById('chatMessages');
        // const typingIndicator = document.getElementById('typingIndicator');

        // Send message on Enter key or button click
        messageInput.addEventListener('keypress', function (e) {
            if (e.key === 'Enter' && messageInput.value.trim() !== '') {
                sendMessage();
            }
        });

        sendButton.addEventListener('click', function () {
            if (messageInput.value.trim() !== '') {
                sendMessage();
            }
        });

        // Option selection functions
        function showContentByNumber(optionNumber) {
            // Hide all content divs first
            document.querySelectorAll('.content').forEach(div => {
                div.classList.add('hidden');
            });

            // Show the selected content
            {% with min_id=faq_category.first.pk max_id=faq_category.last.pk %}
            if (optionNumber >= {{ min_id }} && optionNumber <= {{ max_id }}) {
                {% endwith %}
                document.getElementById('content' + optionNumber).classList.remove('hidden');

                // Scroll to the content
                setTimeout(() => {
                    document.getElementById('content' + optionNumber).scrollIntoView({
                        behavior: 'smooth',
                        block: 'nearest'
                    });
                }, 100);
            }
        }

        function askQuestion(question) {
            // Add the question as a user message and simulate AI response
            messageInput.value = question;
            sendMessage();
        }

        function sendMessage() {
            const message = messageInput.value.trim();

            // Check if message is a valid number and show content directly
            const messageNumber = parseInt(message);
            {% with min_id=faq_category.first.pk max_id=faq_category.last.pk %}
            if (messageNumber >= {{ min_id }} && messageNumber <= {{ max_id }}) {
                {% endwith %}
                // Add user message to chat
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex space-x-3 justify-end message-animation';
                userMessageDiv.innerHTML = `
        <div class="bg-primary-600 text-white rounded-lg p-3 max-w-3xl">
            <p class="text-sm">${message}</p>
            <p class="text-xs text-primary-200 mt-1">Just now</p>
        </div>
        <div class="flex-shrink-0">
            <img src="/media/{{ user.image }}" class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center" alt="">
        </div>`;
                chatMessages.appendChild(userMessageDiv);                          // TODO: THIS TO IMAGE ^

                // Clear input
                messageInput.value = '';

                // Show the corresponding content
                showContentByNumber(messageNumber);

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;  // TODO: REMEMBER TO DO THIS FOR ADMIN TO INDIV POST
                return;
            }

            // Check for invalid numeric options (numbers outside)
            if (!isNaN(messageNumber) && messageNumber !== 0) {
                // Add user message to chat
                const userMessageDiv = document.createElement('div');
                userMessageDiv.className = 'flex space-x-3 justify-end message-animation';
                userMessageDiv.innerHTML = `
        <div class="bg-primary-600 text-white rounded-lg p-3 max-w-3xl">
            <p class="text-sm">${message}</p>
            <p class="text-xs text-primary-200 mt-1">Just now</p>
        </div>
        <div class="flex-shrink-0">
            <img src="/media/{{ user.image }}" class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center" alt="">
        </div>`;
                chatMessages.appendChild(userMessageDiv);

                // Clear input
                messageInput.value = '';

                // Show typing indicator
                // typingIndicator.style.display = 'flex';

                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;

                // Generate invalid option response
                setTimeout(() => {
                    // typingIndicator.style.display = 'none';

                    const aiMessageDiv = document.createElement('div');
                    aiMessageDiv.className = 'flex space-x-3 message-animation';
                    aiMessageDiv.innerHTML = `
            <div class="flex-shrink-0">
                <div class="h-8 w-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                    <i class="fas fa-robot"></i>
                </div>
            </div>
            <div class="bg-primary-50 rounded-lg p-3 max-w-3xl">
                <p class="text-sm">Sorry, "${message}" is not a valid option. Please choose from the available options</p>
                <p class="text-xs text-gray-500 mt-1">Just now</p>
            </div>`;
                    chatMessages.appendChild(aiMessageDiv);

                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 1500);
                return;
            }

            // Regular message handling continues...
            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'flex space-x-3 justify-end message-animation';
            userMessageDiv.innerHTML = `
    <div class="bg-primary-600 text-white rounded-lg p-3 max-w-3xl">
        <p class="text-sm">${message}</p>
        <p class="text-xs text-primary-200 mt-1">Just now</p>
    </div>
    <div class="flex-shrink-0">
        <img src="/media/{{ user.image }}" class="h-8 w-8 rounded-full bg-primary-500 flex items-center justify-center" alt="">
    </div>`;
            chatMessages.appendChild(userMessageDiv);

            // Clear input
            messageInput.value = '';

            // Show typing indicator
            // typingIndicator.style.display = 'flex';

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // Generate contextual AI response based on the message
            setTimeout(() => {
                // Hide typing indicator
                // typingIndicator.style.display = 'none';

                // Generate appropriate response
                let aiResponse = generateAIResponse(message);
                const aiMessageDiv = document.createElement('div');
                aiMessageDiv.className = 'flex space-x-3 message-animation';
                aiMessageDiv.innerHTML = `
        <div class="flex-shrink-0">
            <div class="h-8 w-8 rounded-full bg-primary-100 flex items-center justify-center text-primary-600">
                <i class="fas fa-robot"></i>
            </div>
        </div>
        <div class="bg-primary-50 rounded-lg p-3 max-w-3xl">
            <p class="text-sm">${aiResponse}</p>
            <p class="text-xs text-gray-500 mt-1">Just now</p>
        </div>`;
                chatMessages.appendChild(aiMessageDiv);


                // Scroll to bottom again
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 1500);
        }
        
        function generateAIResponse(message) {
            const lowerMessage = message.toLowerCase();

            // Greeting responses - Handle hello, hi, greetings, etc.
            const greetings = ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good afternoon', 'good evening', 'howdy', 'hiya', 'sup', 'what\'s up'];

            let isGreeting = false;
            for (const greeting of greetings) {
                if (lowerMessage.includes(greeting)) {
                    isGreeting = true;
                    break;
                }
            }

            // console.log(lowerMessage.includes(greetings));

            if (isGreeting) {
                const greetingResponses = [
                    "Hello! Welcome to our university assistant. I'm here to help you with academic support, campus life, financial aid, and library services. How can I assist you today?",
                    "Hi there! I'm your university virtual assistant. I can help you with questions about courses, campus events, scholarships, library resources, and more. What would you like to know?",
                    "Greetings! I'm here to help you navigate university life. Whether you need information about academics, campus activities, financial aid, or library services, I'm ready to assist. What can I help you with?",
                    "Hey! Nice to meet you. I'm your university chatbot assistant. I can provide information about GPA requirements, campus events, scholarships, library hours, and much more. How can I help you today?",
                    "Hello and welcome! I'm here to make your university experience smoother. I can assist with academic questions, campus life, financial matters, and library resources. What would you like to explore?"
                ];
                return greetingResponses[Math.floor(Math.random() * greetingResponses.length)];
            }

            // Check for help or menu requests
            if (lowerMessage.includes('help') || lowerMessage.includes('menu') || lowerMessage.includes('options') || lowerMessage.includes('what can you do')) {
                return "I can help you with various university services! Here are the main areas I cover:<br><br>üìö <strong>Academic Support</strong> - GPA requirements, contacting lecturers, course add/drop<br>üéì <strong>Campus Life</strong> - Events, transportation, clubs, library info<br>üí∞ <strong>Financial Aid</strong> - Scholarships, financial aid applications, tuition payments<br>üìñ <strong>Library Services</strong> - Hours, borrowing, digital resources, study rooms<br><br>You can also type numbers 1-4 to access specific content sections, or just ask me any question!";
            }

            {% for faq in faqs %}
                {% if faq.hasMultipleKeywords %}
            if (lowerMessage.includes('{{ faq.getFirstKeyword|lower }}') {% for keyword in faq.getOtherKeywords %}|| lowerMessage.includes('{{ keyword|lower }}') {% endfor %}) {
                {% else %}
            if (lowerMessage.includes('{{ faq.keywords|lower }}')) {
                {% endif %}
                return "{{ faq.answer|linebreaksbr }}";
            }
            {% endfor %}

            // Default responses for unrecognized input
            const defaultResponses = [
                "I'd be happy to help with that! Could you provide more specific details about what you're looking for? You can ask about academics, campus life, financial aid, or library services.",
                "That's a great question! Let me help you find the information you need. Try asking about GPA requirements, campus events, scholarships, or library hours.",
                "I can assist you with that. I specialize in academic support, campus life, financial aid, and library services. What specific aspect would you like to know more about?",
                "Thanks for reaching out! I'm here to help with all your university-related questions. You can ask about courses, events, scholarships, or any other university services.",
                "I understand you need help with this. Feel free to ask me about academic requirements, campus activities, financial assistance, or library resources!"
            ];

            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }
    </script>
</body>

</html>